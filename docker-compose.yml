services:
  traefik:
    image: traefik:latest
    hostname: traefik.mxrisc.com
    container_name: traefik
    restart: always
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
#      - "--certificatesresolvers.mxrisc.acme.caServer=https://vault.mxrisc.com/v1/pki_mxrisc/acme/directory"
      - "--certificatesresolvers.mxrisc.acme.email=elazaro@mxrisc.com"
      - "--certificatesresolvers.mxrisc.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.mxrisc.acme.httpchallenge=true"
      - "--certificatesresolvers.mxrisc.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.mxrisc.acme.tlschallenge=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--providers.docker=true"
    environment:
      LEGO_CA_CERTIFICATES: "/usr/local/share/ca-certificates/mxrisc-chain.pem"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - ./config/vault/pki/certs/chain.pem:/usr/local/share/ca-certificates/mxrisc-chain.pem
      - "traefik_letsencrypt:/letsencrypt"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`traefik.mxrisc.com`)"
      - "traefik.http.routers.api.service=api@internal"
      - "traefik.http.routers.api.entrypoints=web"
  mysql:
    image: mysql:latest
    hostname: mysql.iam
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: keycloak
      MYSQL_USER: keycloak
      MYSQL_PASSWORD: password
    ports:
      - "3306:3306"
    volumes:
      - mysql-keycloak:/var/lib/mysql
  keycloak:
    image: keycloak/keycloak:latest
    command: start-dev
    container_name: keycloak
    hostname: auth.mxrisc.com
    environment:
      KC_DB: mysql
      KC_DB_URL_HOST: mysql
      KC_DB_URL_PORT: 3306
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password
      KC_HTTP_ENABLED: true
      KC_HTTP_PORT: 80
      KC_HOSTNAME: auth.mxrisc.com
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: password
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth.rule=Host(`auth.mxrisc.com`)"
      - "traefik.http.routers.auth.entrypoints=web"
      - "traefik.http.services.auth.loadbalancer.server.port=80"
    depends_on:
      - mysql
  hashicorp.vault:
    image: hashicorp/vault:1.20
    entrypoint: vault server -config /vault/config/vault.hcl
    hostname: vault.mxrisc.com
    container_name: hashicorp.vault
    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.vault.rule=hostsni(`vault.mxrisc.com`)"
      - "traefik.tcp.routers.vault.tls.passthrough=true"
      - "traefik.tcp.routers.vault.entrypoints=websecure"
      - "traefik.tcp.services.vault.loadbalancer.server.port=443"
    environment:
#      VAULT_DEV_ROOT_TOKEN_ID: mxrisc-root-token
      VAULT_ADDR: 'http://0.0.0.0'
      VAULT_API_ADDR: 'http://0.0.0.0'
    volumes:
      - vault_logs:/vault/logs:rw
      - vault_file:/vault/file:rw
      - ./config/vault/config.d:/vault/config
  wazuh.manager:
    image: wazuh/wazuh-manager:4.12.1-rc1
    hostname: wazuh.manager
    container_name: wazuh.manager
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    ports:
      - "1514:1514"
      - "1515:1515"
      - "514:514/udp"
      - "55000:55000"
    environment:
      - INDEXER_URL=https://wazuh.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
      - SSL_CERTIFICATE=/etc/ssl/filebeat.pem
      - SSL_KEY=/etc/ssl/filebeat.key
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=MyS3cr37P450r.*-
    volumes:
      - wazuh_api_configuration:/var/ossec/api/configuration
      - wazuh_etc:/var/ossec/etc
      - wazuh_logs:/var/ossec/logs
      - wazuh_queue:/var/ossec/queue
      - wazuh_var_multigroups:/var/ossec/var/multigroups
      - wazuh_integrations:/var/ossec/integrations
      - wazuh_active_response:/var/ossec/active-response/bin
      - wazuh_agentless:/var/ossec/agentless
      - wazuh_wodles:/var/ossec/wodles
      - filebeat_etc:/etc/filebeat
      - filebeat_var:/var/lib/filebeat
      - /Users/elazaro/Documents/Proyectos/mxRISC/Java/auth-api/logs:/usr/share/logs
      - ./config/wazuh_indexer_ssl_certs/root-ca-manager.pem:/etc/ssl/root-ca.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.manager.pem:/etc/ssl/filebeat.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.manager-key.pem:/etc/ssl/filebeat.key
      - ./config/wazuh_cluster/wazuh_manager.conf:/var/ossec/etc/ossec.conf
  wazuh.indexer:
    image: wazuh/wazuh-indexer:4.12.1-rc1
    hostname: wazuh.indexer
    container_name: wazuh.indexer
    restart: always
    ports:
      - "9200:9200"
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data:/var/lib/wazuh-indexer
      - ./config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-indexer/certs/root-ca.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.indexer-key.pem:/usr/share/wazuh-indexer/certs/wazuh.indexer.key
      - ./config/wazuh_indexer_ssl_certs/wazuh.indexer.pem:/usr/share/wazuh-indexer/certs/wazuh.indexer.pem
      - ./config/wazuh_indexer_ssl_certs/admin.pem:/usr/share/wazuh-indexer/certs/admin.pem
      - ./config/wazuh_indexer_ssl_certs/admin-key.pem:/usr/share/wazuh-indexer/certs/admin-key.pem
      - ./config/wazuh_indexer/wazuh.indexer.yml:/usr/share/wazuh-indexer/opensearch.yml
      - ./config/wazuh_indexer/internal_users.yml:/usr/share/wazuh-indexer/opensearch-security/internal_users.yml
  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:4.12.1-rc1
    hostname: siem.mxrisc.com
    container_name: wazuh.dashboard
    restart: always
    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.siem.rule=hostsni(`siem.mxrisc.com`)"
      - "traefik.tcp.routers.siem.tls.passthrough=true"
#      - "traefik.http.routers.siem.rule=Host(`siem.mxrisc.com`)"
      - "traefik.tcp.routers.siem.entrypoints=websecure"
      - "traefik.tcp.services.siem.loadbalancer.server.port=5601"
#      - "traefik.http.routers.siem.tls.certresolver=mxrisc"
#      - "traefik.http.routers.siem.tls.domains[0].main=siem.mxrisc.com"
    environment:
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword
      - WAZUH_API_URL=https://wazuh.manager
      - DASHBOARD_USERNAME=kibanaserver
      - DASHBOARD_PASSWORD=kibanaserver
      - API_USERNAME=wazuh-wui
      - API_PASSWORD="MyS3cr37P450r.*-"
    volumes:
      - ./config/wazuh_indexer_ssl_certs/wazuh.dashboard.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.dashboard-key.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard-key.pem
      - ./config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-dashboard/certs/root-ca.pem
      - ./config/wazuh_dashboard/opensearch_dashboards.yml:/usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
      - ./config/wazuh_dashboard/wazuh.yml:/usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml
      - wazuh-dashboard-config:/usr/share/wazuh-dashboard/data/wazuh/config
      - wazuh-dashboard-custom:/usr/share/wazuh-dashboard/plugins/wazuh/public/assets/custom
    depends_on:
      - wazuh.indexer
    links:
      - wazuh.indexer:wazuh.indexer
      - wazuh.manager:wazuh.manager
  openldap:
    image: osixia/openldap:stable-arm64v8
    hostname: openldap.mxrisc.com
    container_name: openldap
    command:
      - "--loglevel=trace"
    restart: always
    environment:
      LDAP_ORGANISATION: 'mxRISC'
      LDAP_DOMAIN: 'mxrisc.com'
      LDAP_BASE_DN: 'dc=mxrisc,dc=com'
      LDAP_ADMIN_PASSWORD: 'admin-password'
      LDAP_CONFIG_PASSWORD: 'config-password'
      LDAP_READONLY_USER: false
      LDAP_RFC2307BIS_SCHEMA: false
      LDAP_BACKEND: 'mdb'
      LDAP_LOG_LEVEL: 128
      LDAP_TLS: false
      LDAP_TLS_CRT_FILENAME: '/usr/local/share/certs/openldap.pem'
      LDAP_TLS_KEY_FILENAME: '/usr/local/share/certs/openldap.rsa'
      LDAP_TLS_DH_PARAM_FILENAME: '/usr/local/share/certs/diffie-hellman-params.pem'
      LDAP_TLS_CA_CRT_FILENAME: '/usr/local/share/certs/mxrisc_certification_chain.pem'
      LDAP_TLS_ENFORCE: false
      LDAP_TLS_CIPHER_SUITE: 
      LDAP_TLS_VERIFY_CLIENT: 'demand'
      LDAP_SEED_INTERNAL_SCHEMA_PATH: /tmp/custom/mxrisc.schema
      LDAP_SEED_INTERNAL_LDIF_PATH: /tmp/custom/structure.ldif
      HOSTNAME: 'openldap.mxrisc.com'
      LDAP_OPENLDAP_UID: 1001
      LDAP_OPENLDAP_GID: 1001
      LDAP_REMOVE_CONFIG_AFTER_SETUP: false
    ports:
      - "389:389"
    volumes:
      - openldap-data:/var/lib/ldap
      - openldap-conf:/etc/ldap/slapd.d
      - ./config/openldap/schema/custom:/tmp/custom
      - ./config/openldap/objects/structure.ldif:/tmp/custom/structure.ldif
      - ./config/mxrisc_tls_certs:/usr/local/share/certs/
    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.ldap.rule=hostsni(`openldap.mxrisc.com`)"
      - "traefik.tcp.routers.ldap.tls.passthrough=true"
      - "traefik.tcp.routers.ldap.entrypoints=websecure"
      - "traefik.tcp.services.vault.loadbalancer.server.port=389"
volumes:
  traefik_letsencrypt:
    external: true
  mysql-keycloak:
    external: true
  wazuh_api_configuration:
    external: true
  wazuh_etc:
    external: true
  wazuh_logs:
    external: true
  wazuh_queue:
    external: true
  wazuh_var_multigroups:
    external: true
  wazuh_integrations:
    external: true
  wazuh_active_response:
    external: true
  wazuh_agentless:
    external: true
  wazuh_wodles:
    external: true
  filebeat_etc:
    external: true
  filebeat_var:
    external: true
  wazuh-indexer-data:
    external: true
  wazuh-dashboard-config:
    external: true
  wazuh-dashboard-custom:
    external: true
  vault_logs:
    external: true
  vault_file:
    external: true
  openldap-data:
    external: true
  openldap-conf:
    external: true
